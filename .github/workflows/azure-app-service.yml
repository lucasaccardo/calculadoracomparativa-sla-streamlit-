# GitHub Actions workflow para deploy no Azure App Service
#
# Este workflow realiza o deploy autom√°tico do aplicativo Streamlit no Azure App Service
# sempre que h√° um push na branch main.
#
# CONFIGURA√á√ÉO NECESS√ÅRIA:
# 1. No portal do Azure, v√° at√© seu Web App > Centro de Implanta√ß√£o
# 2. Baixe o perfil de publica√ß√£o (bot√£o "Obter perfil de publica√ß√£o")
# 3. No GitHub, v√° em Settings > Secrets and variables > Actions
# 4. Crie um novo secret chamado AZURE_WEBAPP_PUBLISH_PROFILE com o conte√∫do do arquivo baixado
# 5. Crie outro secret chamado APP_NAME com o nome do seu Web App (ex: frotas-vamos-sla)
#
# NOTA: Este workflow √© opcional. Se os secrets n√£o estiverem configurados,
# o workflow n√£o executar√° o deploy (mas n√£o causar√° erro).

name: Deploy to Azure App Service

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Permite execu√ß√£o manual

env:
  PYTHON_VERSION: '3.11'

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    # O job s√≥ executa se o secret estiver configurado
    if: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE != '' }}
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Opcional: executar testes se existirem
      # - name: Executar testes
      #   run: |
      #     pip install pytest
      #     pytest

      - name: Deploy para Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ secrets.APP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: .

      - name: Notificar conclus√£o
        run: |
          echo "‚úÖ Deploy conclu√≠do com sucesso!"
          echo "üåê Aplica√ß√£o dispon√≠vel em: https://${{ secrets.APP_NAME }}.azurewebsites.net"
